<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=x-euc-jp">
<TITLE>
B-Free/debug command
</TITLE>
</HEAD>

<BODY BGCOLOR="#ffffff">

<H1>
B-Free OS で何ができるか (コマンドの一覧)
</H1>
<HR>


<DIV ALIGN=LEFT>
<PRE>
$Revision: 1.1 $
$Date: 2011/12/27 17:13:36 $

内藤 隆一
</PRE>
</DIV>


<H2>バージョン 0.0.40 以前とそれ以降の違い</H2>
<P>
B-Free OS のコマンドインタプリタは、バージョン 0.0.40 以降大きく変わりました。
<BR>
このバージョンまでは、コマンドインタプリタは、UNIX のシェル方式(コマンド + 引数)の
形式でした。バージョン 0.0.40 から、コマンドインタプリタ用の言語 (Mitton) がインプリメント
されました。
<BR>
言語 Mitton は、Forth 型の言語であり、コマンドの実行時における引数の指定方法が以前のものとは
全く異なっています。


<H2>B-Free OS のコマンドラインインタプリタ</H2>
<P>
今の B-Free OS は、マネージャ関係がインプリメント中のため、ユーザプロ
グラムの類は動きません。その代わり、デバッグに使うためのコマンドライン
インタプリタが動いています。
B-Free OS が HD/FD から起動すると、プロンプトを表示します。

<BLOCKQUOTE>
<PRE>
	init> 
</PRE>
</BLOCKQUOTE>

<P>
このプロンプトを表示しているのが、コマンドラインインタプリタです。
コマンドラインインタプリタは、独立したプログラムとなっています。
ソースは、B-Free OS のソース環境のディレクトリの kernel/BTRON/init に
入っています。
<P>
将来的には、このコマンドラインインタプリタは、システム全体の立ち上げ処
理の管理処理を担当する予定です。というか、もともと立ち上げ処理のプログ
ラムとして作っています(ファイルも init という名前になっています)。
<P>


<H2>コマンド</H2>
<P>
で、デバッグ用のコマンドラインインタプリタですから、ほとんどマネージャ
とかデバイスドライバなどの動作確認用のコマンドばかりです。
一応カテゴリごとに分かれている風ではありますが、追加は恣意的に行ってい
ますのでかなりいいかげんです。
<P>

以前は、DOS ファイルシステム (FAT16) もアクセスできるコマンドがありま
した。今はコマンドを使用できないようにしています。といっても、#ifdef 
文で囲んでいるだけで、ソースはそのまま残しているので、興味があったら
使ってみることはできます。
<P>

コマンドは、プロンプトの後に続けてます。また、引数をつけることもできま
す。たとえば、echo コマンドの場合だと
<P>
<BLOCKQUOTE>
<PRE>
	init> echo hello world
	      ~~~~~~~~~~~~~~~~
</PRE>
</BLOCKQUOTE>

<P>
というように入力します(下線部が入力部分です)。
各引数は、空白で区切ります。今のところ、「"」や「'」で囲んで空白を含ん
だ引数を入力するようなことはできません。引数は、最大 10 個までつけるこ
とができます(コマンド毎に引数の数はきまっています)。
一行に入力することのできる文字数は、99 文字までです。



<H2>各コマンドの説明</H2>
<P>

では、個々のコマンドの説明をしていきます。使われそうもないコマンドにつ
いては、説明を省略します。
以下では、関係のありそうなコマンドをまとめて説明しています。
<P>


<H3>コマンドラインインタプリンタ自身に関係のあるコマンド</H3>
<P>

他ならぬコマンドラインインタプリンタに関係のあるコマンドとしては、
echo および help があります。

<P>

■ echo
<P>

echo コマンドは任意の数の引数を取り、引数をひとつひとつ改行で区切って
表示します。
<P>

<BLOCKQUOTE>
<PRE>
	echo hello world
</PRE>
</BLOCKQUOTE>

と入力すると、次のように表示します。
<P>

<BLOCKQUOTE>
<PRE>
	hello
	world
</PRE>
</BLOCKQUOTE>

ちなみに、このコマンドはコマンドラインインタプリタの引数の区切りわけの
処理のチェックのために作成しました。実用性は皆無ですね :-P
<P>


■ help
<P>

help コマンドは、コマンドラインインタプリンタで使うことができるコマン
ドの一覧を表示します。
このコマンドは、本当にコマンド名の一覧を表示する「だけ」です。コマンド
毎に何をするかなどの説明などは「一切」表示しません。
<P>

処理的なことをいうと、コマンドを登録しているテーブルにコマンド名が入っ
ており、そのコマンド名を表示しています。
<P>


<H3>システムの挙動を指定する</H3>

<P>
システムの挙動を制御するためのコマンドとして、reset および falldown が
あります。
<P>


■ reset
<P>

reset コマンドは、システムを reset します。
<P>
単にそれだけです。reset する時にマネージャ(もし、動いていれば)に対して
通知などは一切しません。
<P>


■ falldown
<P>

システムを停止させます。
といっても、UNIX の shutdown、Windows のシステムの停止のようなことはし
ません。単にカーネルの中で無限ループさせているだけです。
<P>


<H3>lowlib 関係</H3>

<P>
lowlib (loadable library に非ず) の処理を制御します。
lowlib を起動するための load と、lowlib の一覧を表示する lowlib の 2 
つのコマンドがあります。
<P>

今の処理では lowlib の本体は、boot 時にすべて読み込むようになっており、
ファイルをメモリ中に読み込むことは行っていません。ですから、load コマ
ンドというのは、名は体を表わしていません。この辺は、思いつきでつけてい
るので特に理由があってこういう名前にしているわけではありません。
<P>

今のところ POSIX 環境用の lowlib のソースが入っています。
<P>


■ lowlib
<P>

lowlib コマンドは、メモリ中にある lowlib の一覧を表示します。
一覧は、次のような形式になっています。
<P>

<PRE>
  lowlib の名前  実行開始番地  割り込み No. 割り込み関数アドレス

  lowlib の名前: lowlib を識別するための名前です。
		 システム内でユニークである必要があります。
		 この名前を load コマンドで指定します。

  実行開始番地:	 lowlib のスタートアップ関数のアドレスです。

  割り込み No.:  lowlib の機能は、割り込み(トラップ)を使って呼び出すよ
		 うになっています。この項目は、lowlib が使用する割り込
		 み番号を表示します。
</PRE>
<P>

  割り込み関数アドレス: 上記の割り込みを処理する関数のアドレスです。
<P>

このコマンドは、引数がありません(指定しても無視します)。
<P>


■ load
<P>

load コマンドは、引数で指定した lowlib を起動します。lowlib の起動は、
実行開始番地をそのまま実行することによって行います。このとき、新しいタ
スクを自動的に作るようなことはしません。lowlib によっては初期化処理の
中でタスクを生成するかもしれません。
<P>


<H3>IDE/HD 関係</H3>
<P>

IDE タイプの HD のデバイスドライバをデバッグする時に使用したコマンドで
す。
<P>

■ idestat
<P>

IDE の情報を表示します。表示は、デバイスドライバレベルで行います。
表示する情報は、HD のシリンダ数、ヘッダ数、セクタ数の 3 つです。
引数はありません。
<P>


■ idegeo
<P>

IDE のパーティション情報を表示します。パーティション毎にヘッダ番号、
セクタ番号、シリンダ番号、トータルブロック数、スタートブロック数を
表示します。
引数はありません。
<P>


■ ideread
<P>

第２パーティションの任意のオフセットから 40 バイトデータを読み取り、表
示します。
<P>
(なぜ、第２パーティションか？ 実は、私が使っているマシンでは、第２パー
ティションに B-Free OS を入れているからです :-P)
<P>

<BLOCKQUOTE>
  ideread オフセット
</BLOCKQUOTE>

  オフセット: 任意の整数(バイト)

<P>

<H3>POSIX マネージャ関係</H3>
<P>

FTP サーバにおいてある B-Free OS をそのまま make すると、POSIX マネー
ジャが起動するようになっています。バージョン 0.0.35 では、ファイルの
読み書きができるようになっています。
<P>

ファイルの読み書きをするためには、POSIX ファイルシステムをマウントする
必要がありますが、boot すると自動的にマウントするようになっています。
(HD から起動した場合。FD から起動した場合には、メッセージが出て FD を
入れるよう促します)
<P>

POSIX マネージャは、システムコールに対応したメッセージを受けとって実行
するようになっていますので、ここで説明するコマンドもほとんどがシステム
コールのデバッグ用に作ったものです。
<P>


■ posix
<P>

posix コマンドは、POSIX のファイルシステムを root ファイルシステムとし
てマウントします。POSIX のファイルをアクセスする時には、root ファイル
システムをあらかじめマウントしておく必要があります。が、デフォルトでは、
起動時にすでにマウントしているはずなので、このコマンドを実行する必要は
まずありません。
<P>


<BLOCKQUOTE>
	posix デバイス名
</BLOCKQUOTE>
<P>

のようにファイルシステムとなるデバイスの名前を指定します。
デバイスの名前は、UNIX の規則にしたがい、ファイル名の形式で指定するよ
うになっています。といっても、ファイル名を単純に B-Free のデバイスドラ
イバの名前、デバイス指定子へと置換しているだけです。
指定できるデバイス名は、次のとおりです。
<P>

<BLOCKQUOTE>
<PRE>
	/dev/ideXY	IDE タイプの HD
			X ... ドライブ番号 (0 または 1)	
			Y ... パーティション番号 (1 から 4)

	/dev/fdX	FD (フロッピィディスク)
			X ... ドライブ番号
</PRE>
</BLOCKQUOTE>
<P>
デバイス名が間違っていたりすると、エラーメッセージを出します。

<P>

■ pnoaction
<P>

何もしないシステムコール (noaction) を実行します。
POSIX マネージャの呼び出しの処理が動いているかどうかを確認するために作
りました。
<P>
引数は何もつけず、単にコマンドを指定するだけです。


<P>
■ pdir
<P>

指定したディレクトリの中身を表示します。
引数としてディレクトリを指定する必要があります。
<P>

<BLOCKQUOTE>
<PRE>
	pdir /
</PRE>
</BLOCKQUOTE>

<P>
というように入力すると、root ファイルシステムのトップディレクトリ(root 
ディレクトリ)にあるファイルの一覧が表示されます。
<P>


■ pcat

<P>
指定したファイルの内容を表示します。
<P>

<BLOCKQUOTE>
<PRE>
	pdir /etc/fstab
</PRE>
</BLOCKQUOTE>

<P>
というように入力すると、/etc/fstab というファイルの中身をすべて表示し
ます。
<P>


2.6 その他のコマンド
<P>


■ graph
<P>

おそらく、一番派手なコマンドがこの graph です。
<P>
このコマンドは、コンソール (console) デバイスドライバの VGA 処理のデバッ
グのために作成したものです。
<P>
このコマンドを実行すると、ビデオカードのモードをグラフィクモード (VGA) 
に変更し、一見ウィンドウを表示しているような画面を表示します (が、単
にウィンドウに見えるだけで絵を書いているだけに過ぎなかったりします)。
<P>



<H2>新しいコマンドを作るには</H2>

<P>

新しいコマンドを追加するには、kernel/BTRON/init ディレクトリにある、
command.c を変更する必要があります。
<P>

command.c の最初の方に command_table[] という配列があります。この配列
にコマンドの一覧が書いてあります。
<P>

<BLOCKQUOTE>
<PRE>
	struct command command_table[] =
	{
	  { "echo",		echo },
	  { "help",		help },
	
	  <中略>
	};
</PRE>
</BLOCKQUOTE>

<P>
配列中の各要素は、コマンド名とコマンドを実際に処理する関数のアドレスが
入っています。関数のアドレスを指定するために、配列 command_table[] の
前で関数の定義をする必要があります。
<P>

<BLOCKQUOTE>
<PRE>
	static W	echo (W ac, B **av);
	static W	read (W ac, B **av);
</PRE>
</BLOCKQUOTE>

<P>
関数は、2 つの引数 ac と av を受けとります。ac はコマンドの引数の数 
(何も指定しない場合には、1 となります) を表わしています。av は引数の
実際の中身を指します。この辺は通常のアプリケーションの main 関数と
同じ形式になっています。
<P>

関数は、特に static である必要はありません。command.c のファイルの外に
関数の実体を置いておきたい場合には、ヘッダファイルにその関数の extern 
定義を書いておきます。そして、command.c から include することによって 
配列 command_table[] にその関数のアドレスを指定することができます。
<P>
command.c の中に extern の定義を書くこともできます。しかし、その場合関
数の実体を定義したファイルのために、extern の定義をもう一つ書く必要が
あります。2 重定義はバグの元になるので、ヘッダファイルに extern の定義
を書いた方がいいように思います。
<P>

コマンドを実行する関数は、処理が成功すると 0 を失敗すると 0 以外の数を
返します。といっても、返り値によって何かするわけではないので、常に 0 
を返すようにしても、特に問題は起きないでしょう。
<P>



∞. 変更履歴

1997/11/20 第１版

<HR>
<A href="../index.html">B-Free オフィシャルホームページへ戻る</A>

<HR>
<font size=3>Copyright (C) 1996,1997 B-Free Project<BR></font>
</BODY>
</HTML>