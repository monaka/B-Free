<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=x-euc-jp">
<TITLE>
第 18 回 BTRON Club 発表用資料(草稿)
</TITLE>
</HEAD>

<BODY BGCOLOR="#ffffff">

<H1>
<DIV ALIGN=RIGHT>第 18 回 BTRON Club 発表用資料(草稿)</DIV>
</H1>
<HR>

<H1>B-Free OS 〜 中心核の概要</H1>

<P>
<DIV align=right>内藤 隆一 (night@b-free.orient.co.jp)</DIV>
<DIV align=right>1997 年 5 月 30 日</DIV>

<P>
<HR>
<P>

<H2>中心核</H2>


B-Free OS で最もマシン寄りの部分、それが中心核です。
中心核は、それ自体 ITRON 仕様の OS となっています。
<P>
中心核と上位の層とのインタフェースは、ITRON システムコールとして決め
られたインタフェースを使用しています(一部拡張してあります)。そのため、
異なったCPU上に B-Free OS を移植する場合でも、変更は中心核のみに留め、
上位層の変更は最小限にすることができるようになっています。
<P>
本ドキュメントでは、中心核の機能と構造について説明します。


<H3>中心核の機能</H3>

<P>
中心核は、μITRON 3.0 の基本仕様(一部拡張仕様も含む)準拠のカーネル
です。
<P>
中心核は、周辺核、外核そしてアプリケーションなどの上位層に対して次の機
能を提供します。


<UL>
  <LI> タスク管理
  <LI> 同期・通信機能(IPC)
  <LI> メモリプール管理機能
  <LI> 割り込み管理機能
  <LI> 例外管理機能
  <LI> 時間管理機能
  <LI> システム管理機能
</UL>

<P>
 この他に μITRON 3.0 では規定されていない次の機能も提供します。
<P>

<UL>
   <LI> 仮想メモリ管理機能
</UL>
    
<P>
  中心核は、基本的な OS の機能を上位層に与えます。
<P>
  なお、上位層は中心核に対してシステムコールを発行することによって、
中心核の機能を使用します。しかし、中心核より上位の層(周辺核、外核も含
む)は、すべてメッセージの送受信により要求の送受信を行います。システム
コール( = CPU でのトラップ)を介して呼び出されるというのは中心核だけで
す。

<P>

<H3>システムコール呼び出しの経路</H3>

<P>
  ユーザアプリケーションが、B-TRON の機能を使用する場合、次のような順
序で処理を行います。
<P>

<center>
<IMG SRC=syscall-route.gif ALT="syscall">
<BR>
<I>システムコール呼び出しの経路</I>
</center>

<P>

<OL>
  <LI> ユーザプログラムは、中心核に対してメッセージを送信するシステム
    コールを発行して、周辺核へメッセージを送る。 

  <LI> 周辺核は、送られてきたメッセージを受けとり、メッセージに書かれ
    た要求を実行する。

   <LI> 周辺核は要求を処理すると、結果をメッセージの形にして中心核
     を介してアプリケーションへ送る。

   <LI> ユーザアプリケーションは、返答メッセージを受けとる。
     (システムコールの終了)
</OL>
    
<P>
なお、中心核を呼び出す処理というのは、ライブラリが行うので、アプリケー
ションが中心核を意識することはありません。
<P>
ファイルの読み書きなどの処理は、周辺核のファイル管理マネージャが、メッ
セージを受けとることによって処理します。
<P>

<H4>接続機能について</H4>

<P>
  また、中心核では、μITRON 3.0 で新たに拡張された接続機能に
ついては、サポートしません。異なったホスト間での通信機能については、中
心核よりも更に上位の層でサポートします。
<P>
  μITRON3.0の接続機能を使用しない理由は次のとおりです。

<UL>
  <LI> μITRON 3.0 での通信機能は組み込み機械で CPU が複数ある場合を
    想定している。
  <LI> 基本的に CPU がひとつだけ入っており、他のマシンとは比較的大域
    の広いインタフェース (Ethernet など)が使えるパソコンとは相性が悪い。
</UL>


<H3>中心核の構成</H3>

中心核の構成を図 に示します。

<P>
<center>
<IMG SRC=nucleus.gif ALT="中心核の構成">
<BR>
<I>中心核の構成</I>
</center>
<P>


中心核は、いくつかのモジュールに分かれています。

<P>

<TABLE>
  <TR><TD>タスク管理部分
      <TD>
    タスク管理では、ITRON の意味でのタスクを管理します。タスクは実行
    単位としてのプログラムを意味しています。
    タスク管理部分では、タスクの生成/削除/実行などの操作の他に、タスク
    同士で同期や通信などを行う機能も含んでいます。
  </TR>

  <TR><TD>メモリ管理部分
      <TD>
    メモリ管理部分では、物理メモリの管理を行います。物理メモリは基本的
    にページ単位 (80386 で 4K バイト) で管理を行います。しかし、メモリ
    管理部分が提供するインタフェースでは、バイト単位での物理メモリの取
    得/解放ができるようになっています。
  </TR>

  <TR><TD>割込み/例外管理部分
      <TD>
    割込み管理では、外部割込みおよびトラップ (例外、内部割込み)の割り込みテ
    ーブルへの登録を行います。また、実際に割り込みが起った場合の各関数
    への処理の割り振りも行います。
  </TR>

  <TR><TD>時間管理部分
      <TD>
    一定時間ごとの指定された関数の実行をする機能を提供します。
  </TR>

  <TR><TD>システム管理部分
      <TD>
    バージョン番号などを管理します。
  </TR>

  <TR><TD>仮想メモリ管理部分
      <TD>
    CPU のもつ仮想メモリの管理機構をそのまま提供します。
    更に抽象的な仮想メモリの管理については、周辺核のメモリマネージャが
    行います。<P>
    この仮想メモリの管理は、μITRON 3.0 では規定していないため、B-Free
    独自の仕様を定めます。
  </TR>
</TABLE>


<P>

<H2>仮想記憶</H2>


<H3>i386 での仮想記憶管理機能</H3>

<P>
インテル i386 プロセッサには、ページ単位での仮想記憶を管理する機能があ
ります。
<P>



<H3>モデル</H3>

<P>
B-Free での仮想記憶管理をモデル化したものを 図 に示し
ます。

<P>
<CENTER>
<IMG SRC=model.gif ALT="仮想記憶のモデル">
<BR>
<I>B-Free での仮想記憶のモデル</I>
</CENTER>

<P>
仮想記憶は、リージョン (Region) という単位で管理します。
この場合の管理情報は、仮想領域のアドレス、物理メモリのマップ情報、そし
て、読み書きの許可を表す permission のことです。
<P>
1つのタスクには1つ以上のリージョンを結びつけることができます。
たとえば、BTRON レベルでのユーザプロセス(の中のタスク)は、プログラムの
実行部分(コード部分)が入るテキスト・リージョン、読み書きするためのデー
タが入るデータ・リージョン(実際には、データ・リージョンは、恐らく実行
前に値が決まっている変数が入るリージョンと、実行前には領域だけが決まっ
ているリージョンそして、ヒープのために使われるリージョンの3つのリージ
ョンに分かれます)、そしてスタック領域を表すスタック・リージョンと
いう複数の Region と結びついています。
<P>
タスクが複数のリージョンを所有するのは、次のような利点があります。
<P>

<OL>
<LI> 
   リージョンごとに permission が指定できる。そのことによって、テキス
   トは実行するだけで読み書きできないなどの指定ができる。すべてひとつ
   のリージョンにしてしまうと、permission は最少公倍数的なものになって
   しまうだろう(つまり、読み/書き/実行のすべてを許可した状態になってし
   まう)。

<LI> 
   リージョンを仮想空間の中で離して置くことによって、リージョンの大き
   さを広げることができる。成長するリージョンにはヒープ、スタックなど
   があります。
</OL>

<P>
逆に、複数タスクが1つのリージョンを所有することもできます。この場合、複数のタ
スクから所有されるリージョンは、共有メモリとなります。
<P>

<center>
<IMG SRC=share.gif ALT="複数タスクからの共有">
<BR>
<I>複数タスクからの共有</I>
</center>
<P>


B-Free OS では、デフォルトでデータを共有することはしません。しかし、プ
ログラムの実行部分についてはデフォルトで共有します。これは、プログラム
の実行部分は大抵の場合変更しないため、共有しても他のプロセスに影響をお
よぼすことがないからです。
<P>
プログラムの実行部分を変更するような場合、リージョンを共有しないように
システムに要求する必要があります。もし、共有しているプログラムの実行部
分を変更しようとした場合、メモリの保護違反となりプログラムは、強制終了
します。
<P>
複数のリージョンが、仮想空間の中で重なりあうことはできません。


<H3>リージョンの操作</H3>

<P>
タスクは、リージョンの情報を直接操作することはできません。
そのためリージョンの内容を変更する場合、中心核(ITRON)のシステムコール
を実行する必要があります。
<P>
中心核のもつリージョン操作関数を表 に示します。
もともと ITRON では、仮想記憶操作については定義していません。
そのため、リージョン操作システムールは ITRON で規定している独自システ
ムコールとしてシステムコール名の最初に 'v' がつきます。
<P>



<CENTER>
<I>リージョン操作関数一覧</I>

<TABLE>
<TR>
    <TD>システムコール名
    <TD>機能
</TR>

<TR>
    <TD>vcre_reg  
    <TD>リージョンの生成
</TR>

<TR>
    <TD>vcre_reg  
    <TD>リージョンの生成              
</TR>

<TR>
    <TD>vdel_reg  
    <TD>リージョンの削除              
</TR>

<TR>
    <TD>vmap_reg  
    <TD>リージョンのマップ            
</TR>

<TR>
    <TD>vunm_reg  
    <TD>リージョンのアンマップ        
</TR>

<TR>
    <TD>vdup_reg  
    <TD>リージョンの複製を作る        
</TR>

<TR>
    <TD>vprt_reg  
    <TD>リージョンのプロテクト情報の設定 
</TR>

<TR>
    <TD>vshr_reg  
    <TD>タスク間でのリージョンの共有  
</TR>

<TR>
    <TD>vput_reg  
    <TD>リージョンへの書き込み        
</TR>

<TR>
    <TD>vget_reg  
    <TD>リージョンからの読み込み      
</TR>

<TR>
    <TD>vsts_reg  
    <TD>リージョンの情報              
</TR>

</TABLE>
</CENTER>

<P>

これらのシステムコールは、リージョンの情報をアクセスするだけで CPU の
メモリ管理機能には影響を与えないものもあります。


<HR>
<A href="http://www.b-free.orient.co.jp/index.html">B-Free オフィシャルホームページへ戻る</A>

<HR>
<font size=3>Copyright (C) 1996,1997 B-Free Project<BR></font>
</BODY>
</HTML>
