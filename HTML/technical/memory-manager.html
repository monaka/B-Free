<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=x-euc-jp">
<TITLE>
B-Free Project/Memory manager specification
</TITLE>
</HEAD>
<BODY BGCOLOR="#ffffff">

<H1>
メモリ管理マネージャ
</H1>
<HR>


<H1>このメモについて</H1>

このメモは、B-Free OS のメモリ管理マネージャについて記述したもの
です。


<H1>メモリ管理マネージャの役割</H1>

メモリ管理マネージャは、B-Free OS 上で動いているアプリケーション
のメモリ割り当てを管理します。

アプリケーションは、動作するためにメモリを必要とします。 B-Free
 OS では、アプリケーションは仮想メモリ上で動作するため、物理メモリの
割り当てを行う機能が必要になります。

また、 B-Free OS は、物理メモリよりも多いメモリを塔載しているかの
ように見せかけるための機能 --- 仮想メモリ機能があります。そのため、
実メモリ中にないページをアクセスしたときに、二次記憶装置から実メモリへ
ページ内容を読み込むための機能 --- ページイン と アクセス頻度の低いペー
ジを実メモリから二次記憶装置へ書き込む機能 --- ページアウトのふたつの
機能が必要になります。

B-Free OS のメモリ管理の機能は大きくわけると次のように分けられます。

<UL>
<LI> メモリ関連システムコールの実行
<LI> ページフォールト時のページイン処理
<LI> ページアウト処理
</UL>

これらの機能は、メモリ管理マネージャの異なったモジュールが提供します。


<H1>OS 環境による動作の違いについて</H1>


このメモリマネージャは、以下の OS 環境にて動作します。

<UL>
<LI> BTRON OS 環境
<LI> POSIX 環境
</UL>

メモリマネージャは、これらの環境を区別することはせず同等に扱います。

OS 環境の違いによる処理の変化は、各プロセスの OS 環境提供層である、
LOWLIB が行います。

具体的には、OS 環境によって次の違いが出てきます。

<UL>
<LI> ユーザプロセスの仮想メモリ上のレイアウト
<LI> メモリ取得方法
<LI> コード部分の扱い
</UL>

これらの項目の違いについては、メモリマネージャは意識しません。

lowlib は、自分が提供する環境に合わせてこれらの項目に関係する情
報を操作します。

たとえば、仮想メモリ上のレイアウトについては、OS 環境ごとに決まったレ
イアウトをとるように region の作成およびパラメータの設定を行います。


<H1>プロセスの仮想メモリマップ</H1>

 BTRON OS 環境で動作するプロセスの仮想空間は、図
のようになっています。

<Center>
<IMG SRC=virmem.gif ALT="仮想空間の図">
<P>
プロセスの仮想空間
</Center>


各プロセスには、固有空間として 2G バイト割り当てられます。
ただし、固有空間の上位部の共有メモリ部については、他のプロセスと共有し
ます。


<H1>関連システムコール</H1>

メモリ管理マネージャと関連のあるシステムコールは、表
のように分類できます。

<CENTER>
<TABLE>
<TR>
<TD>分類<TD>内容
</TR>

<TR>
<TD>ローカルメモリ操作 <TD> プロセス毎にもつヒープ領域の操作
</TR>

<TR>
<TD>共有メモリ操作     <TD> すべてのプロセス 
</TR>
</TABLE>
関連システムコール分類
</CENTER>


ただし、次のメモリ操作関係のシステムコールはメモリ管理マネージャを呼び
出さずに、ライブラリ または LOWLIB で処理します。メモリ管理マネージャ
との通信を省略することによって、速度向上を図るためです。

<UL>
<LI>map_mem 仮想メモリに物理メモリをマップします。
<LI>ump_mem 物理メモリのマップを解除します。
</UL>


また、BTRON 1 または BTRON 3 仕様で規定している次のシステムコールにつ
いては、B-Free では、サポートしません。

<UL>
  <LI>set_brk BTRON3 で追加されたシステムコール (詳細不明)
  <LI>apd_mem 物理メモリの追加。
  <LI>get_ptr BTRON1 での 80286 依存システムコール
  <LI>rel_ptr BTRON1 での 80286 依存システムコール
</UL>

メモリを確保するシステムコール (get_lmb()) は、そのプロセスに
仮想メモリを割り当てます。このとき、割り当てた仮想メモリに物理メモリ
は割り当てません。
<P>
get_lmb() を使用する場合、取得したいローカルメモリのサイズをバ
イト単位で指定します。get_lmb() は、取得サイズをページサイズに
切上げてから仮想メモリを取得します。
<P>
仮想メモリ(ページ) を取得するとき、ページの属性として NULL ページを指
定します。ユーザプロセスが該当ページをアクセスしたとき、メモリ管理マネー
ジャは物理メモリ(ページ)を割り当てます。そのときページ内容は 0 でクリ
アします。
<P>
get_lmb() によって、取得した仮想メモリ領域はユーザプロセスが終
了した時点で解放されます。もし、仮想メモリ領域をアクセスしているプロセ
スがひとつだけの場合には、仮想メモリ領域にマッピングしていた物理メモリ
ページも解放します。


<H2>ローカルメモリ操作用のシステムコール</H2>


B-Free OS では、BTRON1 に合わせて各プロセスが独自にもつヒープメ
モリをローカルメモリと呼びます。
<P>
ローカルメモリ操作用のシステムコールは、次のものがあります 
<P>

<CENTER>
<TABLE>
<TR><TD>関数名   <TD> 内容</TR>
<TR><TD>get_lmb  <TD> ローカルメモリを取得する</TR>
<TR><TD>rsz_lmb  <TD> 取得したローカルメモリのサイズを変更する</TR>
<TR><TD>rel_lmb  <TD> ローカルメモリを解放する</TR>
<TR><TD>lmb_siz  <TD> ローカルメモリのサイズを測定する</TR>
<TR><TD>lmb_sts  <TD> ローカルメモリに関する情報を取得する</TR>
</TABLE>
ローカルメモリ操作用システムコール
</CENTER>


<H2>共有メモリ操作用システムコール</H2>

共有メモリを操作するためのシステムコールを表
に示します。

<CENTER>
<TABLE>
<TR><TD>関数名   <TD> 内容</TR>
<TR><TD>cre_mpl  <TD> メモリプールの獲得</TR>
<TR><TD>del_mpl  <TD> メモリプールの削除</TR>
<TR><TD>get_smb  <TD> 共有メモリのブロックを取得する</TR>
<TR><TD>rel_smb  <TD> 共有メモリのブロックを解放する</TR>
<TR><TD>rea_smb  <TD> 共有メモリのブロックの内容を読み取る</TR>
<TR><TD>wri_smb  <TD> 共有メモリのブロックに書き込む</TR>
<TR><TD>smb_adr  <TD> 共有メモリブロックのアドレスの取得</TR>
<TR><TD>smb_key  <TD> 共有メモリブロックのアクセスキーを取得する</TR>
<TR><TD>get_sma  <TD> 共有メモリブロックの属性情報を取得する</TR>
<TR><TD>set_sma  <TD> 共有メモリブロックの属性情報を設定する</TR>
<TR><TD>get_smi  <TD> 共有メモリブロックのユーザ情報のとりだし</TR>
<TR><TD>set_smi  <TD> 共有メモリブロックのユーザ情報の設定</TR>
<TR><TD>smb_sts  <TD> 共有メモリブロック情報の取得</TR>
<TR><TD>mpl_sts  <TD> 共有メモリプール状態の取得</TR>
</TABLE>
共有メモリ操作用システムコール
</CENTER>


共有メモリの概念図を 図に示します。

<P>
<CENTER>
<IMG SRC=shared-memory.gif ALT="共有メモリの概念図">
<BR>
共有メモリの概念図
</CENTER>

<P>
共有メモリは、共有メモリブロックを取得することによって、使用できます。
<P>
共有メモリブロックはメモリプール中にあるメモリ領域のうち指定したサイズ
の領域のことを言います。このメモリブロックへのアクセスはブロックを取得
したプロセス以外にも、アクセスキーを取得したプロセスならばアクセスする
ことができます。
<P>
アクセスキーが、ないプロセスの場合には共有メモリブロックへのアクセスは
できません。アクセスキーは、smb_key() システムコールによって
取得することができます。


<H2>その他のシステムコール</H2>

その他のシステムコールを表に示します。

<CENTER>
<TABLE>
<TR><TD>関数名   <TD> 内容</TR>
<TR><TD>map_mem  <TD> 実メモリのマップ</TR>
<TR><TD>ump_mem  <TD> 実メモリのアンマップ</TR>
<TR><TD>add_swap <TD> スワップデバイス/ファイルの追加</TR>
<TR><TD>del_swap <TD> スワップデバイス/ファイルの登録取り消し</TR>
</TABLE>
その他のメモリ操作用システムコール
</CENTER>

map_mem/ump_mem の2つのシステムコールは、ユーザプロセスが任意
の物理メモリを仮想メモリに割り付けるために使用します。
<P>
通常のメモリを使用する場合には、これらのシステムコールを使う必要はあり
ません。これらのシステムコールは次の目的のために使用できます。
<P>

<UL>
<LI> グラフィック画面(VRAM) を仮想空間にマッピングして、ピクセルを直
  接操作する。
<LI>I/O デバイスが用している物理メモリを仮想空間にマッピングする。
</UL>

<P>
なお、仮想空間はプロセスごとに分離している固有空間とすべてのプロセスで
共通にアクセス可能な共有空間の2つがあります。{\tt map_mem()} は、両方
の種類の仮想空間に物理メモリを割り付けることができます。
<P>
固有空間に物理メモリをマッピングした場合、マッピングしたプロセスがいな
くなると自動的にマップを解除します。
<P>
共有空間にマッピングした場合、共有空間が破棄されるまでマッピングは解除
しません。共有空間にアクセスしたプロセスがいなくなってもマッピングは保
持したままです。
<P>
add_swap は、スワップデバイスを追加します。


<H1>メモリ管理マネージャの内部構造</H1>


この章では、メモリ管理マネージャの内部構造について説明します。
<P>
メモリ管理マネージャは、いくつかのモジュールに分かれています。
<P>
それぞれのモジュールは、次の処理を行います。

<table>
<TR><TD>要求受け付けモジュール
    <TD>メモリ管理マネージャへの要求メッセージの受信処理を行います。
      受信したメッセージの要求の種類ごとに処理モジュールを呼び出します。
      そして最後に処理した結果を要求メッセージを送信元へ送ります。

      処理要求メッセージには、ページフォールトへの対応処理も含まれます。
</TR>

<TR><TD>ページアウト可能ページ選択モジュール
    <TD>ページアウト可能な仮想ページを選択します。
	このモジュールは、ハードウェアの情報を見るためカーネルモードで動
      作します。
</TR>
     
<TR><TD>ページアウトモジュール
    <TD>ページアウト可能ページ選択モジュールが選択したページを二次記憶装
      置に記録し、物理メモリを解放します。
</TR>
</table>

<P>
他の周辺核と違っているのは、メモリ管理マネージャはカーネルモードで動作
しているモジュールがあるということです。



<H2>仮想ページ管理情報</H2>

<P>
メモリ管理マネージャは、各プロセスのもっている仮想メモリ領域の各ページ
の情報を管理しています。
<P>
各ページの管理情報は、図 のようになっています。
<P>

<CENTER>
<IMG SRC=page-status.gif ALT="ページの管理情報">
<P>
仮想ページの管理情報
</CENTER>

<P>
仮想ページの管理情報は、仮想メモリページがページアウト時の場合と実メモ
リにマッピングしている場合とで異なった情報を管理しています。
<P>
ページアウト中の仮想メモリページは、属性情報の他にスワップデバイスまた
はファイルを示すインデックスとスワップデバイス中の位置の2つの情報を保
持しています。
<P>

仮想メモリページが物理メモリをマッピングしている場合、物理メモリのペー
ジ番号によって物理メモリの位置を保持します。
この情報はページアウト時の処理で使用します。



<H2>ページフォールト処理</H2>

ページフォールトは、物理メモリをマップしていない仮想メモリにアクセスし
たときに発生します。 

そのとき、ページフォールトを起こした仮想ページの属性によって、メモリ管
理マネージャの対応が異なります。

表 に、ページの属性を示します。

<CENTER>
仮想ページの属性
<TABLE>
<TR>
<TD>ページの属性<TD>内容</TR>

<TR>
<TD>      ページアウト中ページ <TD> スワップエリアにページアウトしている状態。 
                             ページフォールトが発生したときには、スワッ
                             プからページの内容をもってきます 
</TR>
 
<TR>
<TD>      NULL ページ    <TD> 物理ページは割り当てていない。ページフォールト
                       したときは、NULL クリアするページ 
</TR>

<TR>
<TD>      未変更ページ   <TD> 物理メモリにマップしている。内容を変更していな
                      いページ。物理ページを再使用する場合に中身を保存
                      する必要はありません 
</TR>

<TR>
<TD>      変更済ページ   <TD> 物理メモリにマップしている。内容を変更したペー
                       ジ。物理ページを再使用する場合には、ページアウ
                       トして内容を保存する必要があります 
</TR>

<TR>
<TD>      ページイン中   <TD> ページインの途中であることを示します。ページイ
                       ン処理が終るまで、このページをアクセスしようと
                       したプロセスは、SUSPEND されます 
</TR>
</TABLE>
</CENTER>


さらにこれらの属性に加えてページの read only, read/write のどちらかで
あるかを示す情報が加わります。

ページの属性とページフォールトの処理の関係を表 \ref{tab:fault-doing}
に示します。

<CENTER>
ページの属性とページフォールト処理の関係
<TABLE>
<TR>
<TD>ページ属性
<TD>処理</TR>

<TR>
<TD>      ページアウト中ページ <TD>  ページアウト後、物理メモリを解放せずにも
                       との内容をそのまま使用する 
</TR>

<TR>
<TD>      NULL ページ    <TD> 物理メモリをマップし、ページの内容を NULL クリ
                       アする 
</TR>

<TR>
<TD>      未変更ページ   <TD> ページフォールトは発生しない 
</TR>

<TR>
<TD>      変更済ページ   <TD> ページフォールトは発生しない 
</TR>

<TR>
<TD>      ページイン中   <TD> ページイン処理が終わるまで SUSPEND 
</TR>
</TABLE>
</CENTER>



ページフォールトは、ユーザプロセスの実行中に発生します。
また、ユーザプロセスがシステムコールを呼び出した時のように、
ユーザプロセスが自発的に行うわけではありません。
<P>
そのため、ページフォールトの発生および対応をメモリマネージャに通知する
ための仕組みが必要になります。
<P>
ページフォールトの発生から、メモリマネージャがページフォールトを処理す
るまでのフローは、次のようになります。

<UL>
        <LI> &gt; ページフォールト割り込み発生 &lt;
        <LI> 中心核のページフォールトハンドラが起動
        <LI> 中心核は、割り込みテーブルに登録しているプロセスの 
          LOWLIB のページフォールトハンドラを呼び出す。
        <LI> LOWLIB のフォールトハンドラは、プロセスの仮想ページ情報
          から、仮想メモリの属性を得る(メモリ管理マネージャへの問い合
          わせ)。
        <LI> プロセスに割り当てていない仮想ページの場合は、アプリケー
          ションにエラーを返し、 (不正メモリアクセスエラー) 処理を終了
          する。
        <LI> 仮想メモリに物理メモリを割り当てる(中心核の vmap_reg() システムコール)。
        <LI> もし、二次記憶装置にページアウトされていたページの場合に
          は、ファイルマネージャもしくはデバイスマネージャからページの
          内容を読み込む。
        <LI> 未初期化済ページの場合には、仮想メモリページを NULL クリ
          アする。
</UL>


<H2>ページアウト処理</H2>

ページアウトは、ページインの反対の処理を行います。

ページインは、二次記憶装置に追い出された仮想メモリページを実メモリに
読み込む処理でした。
ページアウトは、実メモリにある仮想メモリページを二次記憶装置に追い出す
処理を行います。

ページアウト処理は、大きく二つの別々の処理を行います。

<UL>
  <LI> ページアウトする仮想ページの選択
  <LI> 選択した仮想ページを二次記憶装置に書き出す
</UL>

以下では、それぞれの処理について説明します。


<H3>ページアウト用仮想ページの選択</H3>

ページアウト可能な仮想ページの選択は、カーネルモードで動作する
モジュールが行います(中心核にリンクしたモジュールです)。

このモジュールでは、ページアウトすることができる仮想ページの選択を行い
ます。二次記憶装置へのアクセス(書き込み)は行いません。

ページアウト可能なページの選択は、一定時間アクセスしていないページを検索
することによって行います。

このモジュールの処理フローを以下に示します。

<P>
<PRE>
        for (すべてのタスクの最初から最後まで)
          {
            for (タスクのマップテーブルの最初から最後まで)
              {
                 アクセスビットをクリア。
              }
          }

        for (すべてのタスクの最初から最後まで)
          {
            for (タスクのマップテーブルの最初から最後まで)
              {
                アクセスビットをチェック。
                もし、アクセスビットが立っていなかった(クリアしてから今まで
                誰もアクセスしていない)場合には、ページアウト可能ページとして
                ユーザモードで動いているモジュールに情報を送信。
              }
          }
</PRE>
<P>
ページアウト処理は、全実メモリサイズのうち空きページの割合によってペー
ジアウトする頻度を調節します。 
<P>
ページアウトの頻度は、図のようになります。
定数 <B>PAGE_MAX_FREE</B> で示す数値より多く空いている実メモリがある
場合、ページアウト処理は行いません。空いている実メモリが <B> PAGE_MAX_FREE</B>
よりも少くなった場合、<B>PAGE_MIN_FREE</B> よりも
多い場合には、ユーザプロセスを実行したままページアウト処理を行います。

さらに、<B>PAGE_MIN_FREE</B> よりも空いている実メモリが少なくなった場合、
メモリ管理マネージャは、緊急処理モードに入ります。ページアウトモジュー
ルのもっているタスクのプライオリティを上げ、ユーザプロセスのもつタスク
を停止させます。そして、実メモリをマッピングしている仮想ページのうち、
未変更ページをすべてパージします。もし、これでも <B>PAGE_MIN_FREE</B>
より空きメモリが増えなかった場合、変更済ページをページアウトします。

<center>
<img src="pageout-graph.gif" ALT="ページアウトの頻度">

ページアウトの頻度
</center>



<H4>二次記憶装置にページの内容を書き込む</H4>

<P>
ページアウト仮想ページの選択モジュールが選んだページアウト可能な仮想ペー
ジは、ユーザレベルで動作しているモジュールが行います。
<P>

このモジュールは、ページアウト可能なページの内容を中心核のシステムコー
ル (<B>vrea_reg()</B>)を使って読み取ります。このシステムコールは、指定
したタスクの任意のページの内容を読み取ることができます。
<P>

次に、読み込んだページの内容を二次記憶装置に書き込みます。
そのとき、単に二次記憶装置に書き込んだだけではページインの時に困ってし
まうので、メモリマネージャのもつ仮想ページテーブルにどこにページアウト
したかを記録します。
<P>

このテーブルは、ページインのときにどこから読み取ればいいかを決定するた
めに参照します。
<P>

ページアウトは、スワップ領域が HD のパーティションとして独立している場
合には、デバイスマネージャを、BTRON 上の独立したファイルがスワップ用と
して使われている場合には、ファイルマネージャを介して出力します。

<HR>



<HR>
<A href="../index.html">B-Free オフィシャルホームページへ戻る</A>

<HR>
<font size=3>Copyright (C) 1996,1997 B-Free Project<BR></font>
</BODY>
</HTML>

